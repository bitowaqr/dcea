---
title: "Equity impact report"
date: "`r Sys.Date()`"
output: 
 word_document:
    reference_docx: "template.docx"
params:
  intName: NA
  compName: NA
  disthoc_plot: NA
  report_distr_plots: NA
  final_dtbl: NA
  sii: NA
  nhb: NA
  report_ce_plane: NA
  report_equity_nhb_plot: NA
  report_equity_icer_plot: NA
  input_names: NA
  input_values: NA
  thresh: NA
  icer: NA
  inmb: NA
  eip_aversion: NA
  weighted_icer: NA
  weighted_inmb: NA
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```


```{r message=FALSE, warning=FALSE, include=FALSE}
library(ggplot2)
library(cowplot)
```


:::{custom-style="Author"}
This report was generated by entering various user-defined assumptions into a prototype health inequality impact calculator produced by the University of York (https://shiny.york.ac.uk/dceasimple). The University of York offers no guarantees or warranties of any kind for the assumptions used and the results produced.
:::

This first page summarises the main results; the user-defined assumptions are listed on the next page; and further pages show various graphs.

***

The following analysis compares **`r params$intName`** against **`r params$compName`**. 


Table: **Table 1**: Main model results

|   |   |
|---	|---	|
| Net health benefit: 	| **`r params$nhb` QALYs** 	|
| Net health inequality benefit: | **`r params$sii` QALYs**  	|
|   Decision threshold	|  **£`r params$thresh` **	|
| Atkinson parameter |  **`r params$eip_aversion`** |  
| Incremental Cost-Effectiveness Ratio (ICER) | **£`r params$icer`/QALY** |
| Incremental Net Monetary Benefit (INMB) per recipient | **£`r params$inmb`** |
Equity-weighted ICER | **`r params$weighted_icer`** |
Equity-weighted INMB | **`r params$weighted_inmb`** | 

****



```{r echo=FALSE, warning=FALSE}
final_dtbl = params$final_dtbl
final_dtbl[is.na(final_dtbl)] = ""
knitr::kable(
  final_dtbl[,-c(8:9)],
  row.names = F,
  align = "lccccc",
  caption = "**Table 2**: Distributional results",
  booktabs=  T
  )
```

****

### Inputs

This section summarises the user-defined assumptions used to create the results and plots.

```{r echo=FALSE}
input_table = c()
for(i in seq_along(params$input_names) ){
  lab_i = names(params$input_names)[i]
  val_i = params$input_values[[i]]
  if(length(params$input_values[[i]])>1){
    val_i = paste0(val_i,collapse = "; ")
  }
  if(sum(c("numeric","integer") %in% class(val_i))>0){
    if(val_i<=1){
      val_i = formatC(val_i,digits = 3, format = "f")
    } else {
     val_i = formatC(val_i,digits = 0, big.mark = ",", format = "f")
    }
  }
  if(is.null(val_i)){
    val_i = ""
  }
  input_table = rbind(
    input_table,
    c(lab_i,val_i)
    )
}
kable(
  input_table,
  caption = "**Table 3**: Input parameters",
  col.names = c("Variable","Value")
  )
```


\newpage

### Distributional health impact

```{r echo=FALSE, warning=FALSE, fig.height=16, fig.width=14}
cowplot::plot_grid(plotlist = params$report_distr_plots,nrow = 3)
```


\newpage

### Equity & efficienty

```{r echo=FALSE, warning=FALSE, fig.height=10, fig.width=8}

ll = theme(legend.position = "left")
nl = theme(legend.position = "none")
l2 = cowplot::get_legend(params$report_equity_nhb_plot+ll)
l3 = cowplot::get_legend(params$report_equity_icer_plot+ll)
l1 = cowplot::get_legend(params$report_ce_plane+ll)

cowplot::plot_grid(
  params$report_equity_icer_plot+ nl,l3,
  params$report_equity_nhb_plot + nl,l2,
  params$report_ce_plane + nl,l1,
  rel_widths = c(1,0.5),
  label_size = 10,
  label_fontface = "bold",
  nrow = 3,
  labels = c(
    "Equity - ICER trade-off","",
    "Equity - net health impact trade-off","",
    "CE-Plane",""
    )
)
```



