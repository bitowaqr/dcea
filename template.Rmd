---
title: "Equity impact report"
date: "`r Sys.Date()`"
output: 
 word_document:
    reference_docx: "template.docx"
params:
  intName: NA
  compName: NA
  disthoc_plot: NA
  report_distr_plots: NA
  final_dtbl: NA
  sii: NA
  nhb: NA
  report_ce_plane: NA
  report_equity_nhb_plot: NA
  report_equity_icer_plot: NA
  input_names: NA
  input_values: NA
  thresh: NA
  icer: NA
  icer_change_abs: NA
  icer_change_rel: NA
  thresh_implied_wt: NA
  inmb: NA
  eip_aversion: NA
  weighted_icer: NA
  weighted_inmb: NA
  weighted_inhb: NA
  marginal_productivity: NA
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```


```{r message=FALSE, warning=FALSE, include=FALSE}
library(ggplot2)
library(cowplot)
```


This report was generated by entering user-defined assumptions into a health inequality impact calculator (https://shiny.york.ac.uk/dceasimple) produced by the University of York. The University of York offers no guarantees of any kind for the results produced.


***
The following analysis compares **`r params$intName`** against **`r params$compName`**. 



Table: **Table 1**: Main model results

|   |   |
|---	|---	|
| Net health inequality benefit | **`r params$sii` QALYs**  	|
| Incremental Cost-Effectiveness Ratio (ICER) | **£`r params$icer`/QALY** |
Equity-weighted ICER | **`r params$weighted_icer`** |
| ICER change | **£`r params$icer_change_abs` (`r params$icer_change_rel`%)** |
| Treshold weight | **x`r params$thresh_implied_wt`** |
| Incremental Net Health Benefit (INHB) 	| **`r params$nhb` QALYs** 	|
| Equity-weighted INHB | **`r params$weighted_inhb`** | 
|   Decision threshold	|  **£`r params$thresh` **	|
|   Marginal productivity	|  **£`r params$marginal_productivity` **	|
| Atkinson parameter |  **`r params$eip_aversion`** |  

****



```{r echo=FALSE, warning=FALSE}
final_dtbl = params$final_dtbl
final_dtbl[is.na(final_dtbl)] = ""
knitr::kable(
  final_dtbl[,-c(8:9)],
  row.names = F,
  align = "lccccc",
  caption = "**Table 2**: Distributional results",
  booktabs=  T
  )
```

\newpage

### Inputs

This section summarises the user-defined assumptions used to create the results and plots.

```{r echo=FALSE}
input_table = c()
for(i in seq_along(params$input_names) ){
  lab_i = names(params$input_names)[i]
  val_i = params$input_values[[i]]
  if(length(params$input_values[[i]])>1){
    val_i = paste0(val_i,collapse = "; ")
  }
  if(sum(c("numeric","integer") %in% class(val_i))>0){

    if(lab_i == "Incremental QALYs"){
      val_i = signif(val_i,3)
    } else {
      if(val_i<=1){
        val_i = formatC(val_i,digits = 3, format = "f")
      } else {
      val_i = formatC(val_i,digits = 0, big.mark = ",", format = "f")
      }
    }
  }
  if(is.null(val_i)){
    val_i = ""
  }
  input_table = rbind(
    input_table,
    c(lab_i,val_i)
    )
}
kable(
  input_table,
  caption = "**Table 3**: Input parameters",
  col.names = c("Variable","Value")
  )
```


\newpage

### Distributional health impact


```{r echo=FALSE, warning=FALSE, fig.height=6, fig.width=14}
cowplot::plot_grid(plotlist = list(params$report_distr_plots[[1]],NULL,NULL),nrow = 1)
```

```{r echo=FALSE, warning=FALSE, fig.height=6, fig.width=14}
cowplot::plot_grid(plotlist = params$report_distr_plots[-1],nrow = 1)
```


\newpage

### Equity & efficiency

```{r echo=FALSE, warning=FALSE, fig.height=10, fig.width=8}

ll = theme(legend.position = "left")
nl = theme(legend.position = "none")
l2 = cowplot::get_legend(params$report_equity_nhb_plot+ll)
l3 = cowplot::get_legend(params$report_equity_icer_plot+ll)
l1 = cowplot::get_legend(params$report_ce_plane+ll)

cowplot::plot_grid(
  params$report_equity_icer_plot+ nl,l3,
  params$report_equity_nhb_plot + nl,l2,
  params$report_ce_plane + nl,l1,
  rel_widths = c(1,0.5),
  label_size = 10,
  label_fontface = "bold",
  nrow = 3,
  labels = c(
    "Equity - ICER trade-off","",
    "Equity - net health impact trade-off","",
    "CE-Plane",""
    )
)
```



